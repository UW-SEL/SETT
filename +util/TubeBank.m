function [DP, h] = TubeBank(V, N_L, D, S_T, S_L, rho, mu, k, Pr)

% TubeBank returns the heat transfer coefficient, h, and pressure drop for external cross flow through a staggered bank of cylinders    
% The procedure uses correlations and correction factors provided by Å½ukauskas (1972). 
% These correlations apply for values of Reynolds numbers from ~30<Re<1e8 and Prandtl numbers from ~0.7<Pr<500. 
% At Reynolds numbers 100<Re<1000, the coefficient of heat transfer can be calculated assuming a single cylinder in crossflow. 
% Under those conditions the Churchill and Bernstein correlation(1977) is used.
%
% Inputs
% fluid - string containing the fluid, must be included in one of the
% utility functions
% N_L - number of tubes in the longitudinal direction
% D - diameter of tubes (m)
% S_T - transverse pitch (m)
% S_L - longitudinal pitch (m)
% rho - fluid density (kg/m^3)
% mu - fluid viscosity (Pa-s)
% k - fluid conductivity (W/m-K)
% Pr - fluid Prandtl number (-)
%
% Outputs
% h - heat transfer coefficient (W/m^2-K)
% DP - pressure drop (Pa)


%pitch to diameter ratios
a=S_T/D; 
b=S_L/D;	

S_D=(S_L^2+(S_T/2)^2)^(1/2); %diagonal pitch

%find maximum velocity
if(S_D<(S_T+D)/2)
 	V_max=S_T/(2*(S_D-D))*V;
else
	V_max=S_T/(S_T-D)*V;
end

Re=rho*V_max*D/mu; %Reynolds number

if(a<1.25) 
     warning('The transverse pitch, S_T/D is out of range for ExternalFlow_Staggered_Bank. The minimum value is 1.25 while the value supplied is XXXA1',a);
end
if(a>5) 
    warning('The transverse pitch, S_T/D is out of range for ExternalFlow_Staggered_Bank. The maximum value is 5 while the value supplied is XXXA1',a);	%Note that interpolation/extrapolation will still be used to find value regardless of validity
end

if (Re>10) & (Re<=100)  
 	C=0.90;
 	m=0.40;
 	Nusselt=C*(Re^m)*(Pr^(0.36));
end
if (Re>100) & (Re<=1000)
 	Re2=rho*V*D/mu;
    Nusselt=0.3+(0.62*Re2^(1/2)*Pr^(1/3))/(1+(0.4/Pr)^(2/3))^(1/4)*(1+(Re2/282000)^(5/8))^(4/5);
    C_d=1.18+6.8/Re2^0.89+1.96/Re2^0.5-0.0004*Re2/(1+3.64e-7*Re2^2); 	
end
if(Re>1000) & (Re<=2e5)
	if(S_T/S_L<2) 
 		C=0.35*(S_T/S_L)^(1/5);
 		m=0.60;
 	else
 		C=0.40;	
 		m=0.60;
 	end
 	Nusselt=C*(Re^m)*(Pr^(0.36));
end
if(Re>2e5) & (Re<2e6)
	if(Pr>0.65) & (Pr<0.75)
		C=0.027*(S_T/S_L)^0.2;
		m=0.8;
	    Nusselt=C*(Re^m)*(Pr^(0.36));
    end
	if(Pr>=0.75)
		C=0.031*(S_T/S_L)^0.20;
		m=0.80;
	    Nusselt=C*(Re^m)*(Pr^(0.36));
    end
end	
if (N_L<20) & (Re>1e3) 	
    %get correction factor for small tube bank
    N_Lv=[1,2,3,4,5,7,10,13,16,20];
    chiv=[0.640000000000000,0.760000000000000,0.840000000000000,0.890000000000000,0.920000000000000,0.950000000000000,0.970000000000000,0.980000000000000,0.990000000000000,1];
    chi = interp1(N_Lv,chiv,N_L);
    Nusselt=chi*C*Re^m*Pr^0.36;
end
if (N_L>=20) & ((Re<1e2) | (Re>1e3))
 	Nusselt=C*Re^m*Pr^0.36;
end
 
%pressure drop
var=a/b;
Rev=[10,17.1200000000000,29.3000000000000,50.1500000000000,85.8400000000000,146.900000000000,251.500000000000,430.500000000000,736.800000000000,1261,2159,3695,6325,10826,18530,31717,54288,92924,159054,272248,465997,797632,1370000,2340000,4000000];
av=[1.25000000000000,1.50000000000000,2,2.50000000000000];
Eum=[24.7000000000000,9.39800000000000,4.00300000000000,2.47400000000000;15.1000000000000,5.91900000000000,2.94500000000000,1.93800000000000;8.93600000000000,3.73200000000000,2.16900000000000,1.51900000000000;5.35400000000000,2.42800000000000,1.60500000000000,1.19000000000000;3.26900000000000,1.66200000000000,1.21200000000000,0.935300000000000;2.12000000000000,1.24100000000000,0.915500000000000,0.743600000000000;1.49300000000000,0.972000000000000,0.728000000000000,0.610400000000000;1.15400000000000,0.790600000000000,0.609500000000000,0.520200000000000;0.949200000000000,0.678400000000000,0.532500000000000,0.459100000000000;0.811200000000000,0.601000000000000,0.476700000000000,0.415600000000000;0.726400000000000,0.546200000000000,0.446100000000000,0.396800000000000;0.665400000000000,0.503100000000000,0.422900000000000,0.373200000000000;0.593900000000000,0.458900000000000,0.404100000000000,0.359000000000000;0.520800000000000,0.408500000000000,0.359200000000000,0.323400000000000;0.449200000000000,0.356500000000000,0.314000000000000,0.287100000000000;0.389800000000000,0.307700000000000,0.273000000000000,0.250300000000000;0.335500000000000,0.266300000000000,0.233900000000000,0.215500000000000;0.293700000000000,0.228200000000000,0.203300000000000,0.184000000000000;0.254000000000000,0.197400000000000,0.173000000000000,0.158600000000000;0.224100000000000,0.169200000000000,0.151700000000000,0.138200000000000;0.221500000000000,0.186800000000000,0.171600000000000,0.151800000000000;0.225200000000000,0.203500000000000,0.189300000000000,0.180300000000000;0.225800000000000,0.204000000000000,0.189800000000000,0.181700000000000;0.226300000000000,0.204500000000000,0.193000000000000,0.182200000000000;0.226900000000000,0.205000000000000,0.193500000000000,0.182600000000000]';
Eu=interp2(Rev,av,Eum,Re,a,'spline');

varv=[0.100000000000000,0.400000000000000,0.461900000000000,0.533400000000000,0.616000000000000,0.711300000000000,0.821500000000000,0.948600000000000,1.09500000000000,1.26500000000000,1.46100000000000,1.68700000000000,1.94800000000000,2.25000000000000,2.59800000000000,3]';
Rev2=[100,1000,10000,100000,1000000]';
chim=[0.993000000000000,1.15000000000000,1.43000000000000,1.82000000000000,1.82000000000000;0.995500000000000,1.04800000000000,1.22800000000000,1.50100000000000,1.50100000000000;0.996300000000000,1.03200000000000,1.18900000000000,1.43600000000000,1.43600000000000;0.997100000000000,1.01700000000000,1.15000000000000,1.36800000000000,1.36800000000000;0.997900000000000,1.00600000000000,1.10900000000000,1.30300000000000,1.30300000000000;0.998700000000000,1.00200000000000,1.07700000000000,1.23800000000000,1.23800000000000;0.999500000000000,0.999500000000000,1.04800000000000,1.17200000000000,1.17200000000000;1,1,1.02600000000000,1.10700000000000,1.10700000000000;1.00300000000000,1.01000000000000,1.01400000000000,1.04300000000000,1.04300000000000;1.04000000000000,1.02800000000000,1.01100000000000,0.981800000000000,0.981800000000000;1.12600000000000,1.06800000000000,1.01600000000000,0.955800000000000,0.955800000000000;1.21600000000000,1.11300000000000,1.02500000000000,0.947500000000000,0.947500000000000;1.30600000000000,1.15800000000000,1.04000000000000,0.941400000000000,0.941400000000000;1.40000000000000,1.19800000000000,1.05800000000000,0.937700000000000,0.937700000000000;1.49100000000000,1.24300000000000,1.07700000000000,0.938500000000000,0.938500000000000;1.58100000000000,1.29100000000000,1.10100000000000,0.943800000000000,0.943800000000000]';
chi=interp2(varv,Rev2,chim,var,Re,'spline');

DP_row=(1/2)*Eu*rho*V_max^2*chi;  %average pressure drop across 1 row"
DP=DP_row*N_L;  %total pressure drop
h=Nusselt*k/D;  %heat transfer coefficient




